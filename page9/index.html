<!DOCTYPE html>
<html lang="en">
<head>
	<title>Alexander's Ulizko blog</title>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" />
</head>
<body>
<div id="wrapper">
	<div id="header">
    	<h1><a href="/">Alexander's Ulizko blog</a></h1>
	</div><!-- close:header -->
    <div id="content">
		<div id="main-content">

            
	<div class="post" id="post-/posts/145">
		<h2><a href="/posts/145" rel="bookmark" title="Автоматизируем клиентскую оптимизацию">Автоматизируем клиентскую оптимизацию</a></h2>
		<span class="date">2008 / 11 / 25</span>
		<div class="entry">
			<h2 id='id6'>Предыстория</h2>

<p>Как известно, перед тем, как выложить сайт в нет, мы его разрабатываем. И делаем мы это, как ни странно, на машине разработчика. И давно замечено, что javascript, а в некоторых случаях и css удобнее при разработке держать в нескольких файлах.</p>

<p>Проблема в том, что, согласно принципам, описанным в статье <a href='http://developer.yahoo.com/performance/rules.html'>Best Practices for Speeding Up Your Web Site</a> (перевод доступен на сайте <a href='http://webo.in/articles/habrahabr/15-yahoo-best-practices/'>webo.in</a>), для ускорения загрузки сайта нам нужно произвести следующие манипуляции над javascript и css файлами:</p>

<ol>
<li>Слить весь javascript в один файл, причем, желательно так, чтобы сохранился нужный порядок - т.е., скажем, библиотека jQuery - была ближе к началу, а функции и объекты, которые ее используют - после нее.</li>

<li>Слить весь css в один файл</li>

<li>Сжать эти большие файлы с помощью какой-нибудь утилиты вроде yui-compressor (за исключением css-файлов, название которых начинается, скажем, с префикса ie_, которые содержат data:URL, и поэтому критично относятся к переходам со строки на строку, так что их для собственного спокойствия лучше не сжимать)</li>

<li>Расположить их в таком порядке - css-файл как можно ближе к открывающему тэгу head, а js-файл - как можно ближе к закрывающему тэгу body.</li>

<li>Выставить HTTP-заголовок expires на подольше, чтобы браузер пользователя их закешировал. Ну а для того, чтобы при следующем билде у пользователя обновился js и css надо этим файлам дать какое-нибудь уникальное имя.</li>

<li>Перед отдачей файлов клиенту сжимать их с помощью gzip</li>
</ol>

<h2 id='___'>К чему это я?</h2>

<p>Пункты 5 и 6 уже подробно расписаны в <a href='http://webo.in/articles/all/http-caching/'>других</a> <a href='http://webo.in/articles/all/mod-gzip-minify-on-fly/'>местах</a>.</p>

<p>Я же хочу рассмотреть в этой статье вопрос автоматизации пунктов 1,2,3,4. А точнее, я хочу предложить инструмент, с помощью которого одним (ну, максимум - двумя-тремя :) нажатием кнопки можно выполнить пункты 1, 2, 3, 4 настоящего списка и получить готовые к заливке на сервер javascript и css файлы.</p>

<h2 id='id7'>Инструментарий</h2>

<ul>
<li>Apache <a href='http://ant.apache.org/'>Ant</a> в качестве сборщика. Выбор пал на него за скорость работы, доступность, кроссплатформенность, а также то соображение, что получившийся скрипт легко включить в более общий скрипт выкладывания проекта на production, который будет выполнять какой-нибудь CI-tool, скажем, <a href='http://www.jetbrains.com/teamcity/'>teamcity</a>.</li>

<li>В качестве утилиты сжатия js и css файлов <a href='http://developer.yahoo.com/yui/compressor/'>YUI Compressor</a>. Взят за кроссплатформенность, адекватность, хорошую скорость работы</li>

<li>В качестве валидатора javascript <a href='http://code.google.com/p/jslint4java/'>JSLint4Java</a> (порт JSLint на java). Мы же не хотим выкладывать нерабочий код на продакшен, верно? Кстати, фраза, написанная на офф. сайте, &#8220;JSLint may hurt your feelings&#8221; очень даже справедлива :)</li>
</ul>

<h2 id='__'>Алгоритм работы скрипта</h2>

<ol>
<li>Скачиваем и распаковываем JSLint4Java и YUI Compressor, кладем их в папочку tools внутри проекта. Правильнее, конечно, ложить ее куда-нибудь в место, определенное системной переменной, что-нибудь вроде $TOOLS_LOCATION, но в демонстрационном скрипте и так сойдет, а уж вы для себя поправьте скрипт, как вам нужно.</li>

<li>Натравливаем JSLint4Java на все js-файлы. Если JSLint находит какую-нибудь ошибку, выводим ее на экран и останавливаем выполнение скрипта.</li>

<li>Сливаем все js-файлы, за исключением тех, в имени которых есть фраза test, в один файл с уникальным именем, при этом сохраняем порядок следования файлов, который мы где-нибудь в другом месте определим. В качестве уникального имени давайте возьмем такую конструкцию: main.hh.dd.MM.yy.js, где hh, dd, MM, yy, соответственно, текущие час, день, месяц, год.</li>

<li>Сливаем все css-файлы, за исключением тех, имя которых начинается с ie_ в один файл с уникальным именем (имя такое же, как и в предыдущем пункте, только расширение сменится на <code>css</code>). Порядок следования в данном случае не важен.</li>

<li>Натравливаем на получившиеся файлы YUI Compressor. Если при сжатии произошла ошибка, выводим на экран ошибку и останавливаем выполнение скрипта.</li>

<li>В html-темплейте, который подключает все файлы стилей, удаляем все тэги link, кроме тех, в src которых прописаны файлы ie_ и тех, которые содержат правила стилей, а не подключают внешний css-файл при помощи атрибута src.</li>

<li>В том же темплейте удаляем все тэги скрипт, кроме тех, которые содержат javascript-код (а не подключают внешний файл скрипта через атрибут src).</li>

<li>В том же темплейте прописываем получившийся css-файл как можно ближе к открывающему тэгу head.</li>

<li>В том же темплейте прописываем получившийся js-файл как можно ближе к закрывающему тэгу body или открывающему тэгу script получившийся js-файл.. Такое странное поведение нужно вот для чего: предположим, что мы в js-файле прописали какие-то библиотечные функции, а прямо в html-файле инициализируем прямо в server-side коде js-объекты какими-то данными. Вот для этого-то нам и нужно сохранить script-тэг, а также подключить получившийся js-файл до него.</li>

<li>Выкладываем получившиеся js, css, html файлы в какую-нибудь директорию.</li>
</ol>

<h2 id='_'>Пример реализации</h2>
<div class='highlight'><pre><code class='xml'><span class='lineno'>  1</span> <span class='cp'>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class='lineno'>  2</span> <span class='nt'>&lt;project</span> <span class='na'>name=</span><span class='s'>&quot;production-build&quot;</span> <span class='na'>default=</span><span class='s'>&quot;build&quot;</span> <span class='na'>basedir=</span><span class='s'>&quot;.&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>  3</span>     <span class='c'>&lt;!-- место, куда будем складывать свежескачанные yui-compressor и jslint4java --&gt;</span>
<span class='lineno'>  4</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;tools.location&quot;</span> <span class='na'>value=</span><span class='s'>&quot;tools/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>  5</span>     <span class='c'>&lt;!-- какую версию yui compressor&#39;а и откуда качать, а также, какое имя будет у получившегося jar-файла --&gt;</span>
<span class='lineno'>  6</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;yuicompressor-version&quot;</span> <span class='na'>value=</span><span class='s'>&quot;2.4.2&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>  7</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;yuicompressor-zip&quot;</span> <span class='na'>value=</span><span class='s'>&quot;yuicompressor-${yuicompressor-version}.zip&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>  8</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;yuicompressor-unzip-dir&quot;</span> <span class='na'>value=</span><span class='s'>&quot;yuicompressor-${yuicompressor-version}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>  9</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;yuicompressor-location&quot;</span> <span class='na'>value=</span><span class='s'>&quot;http://www.julienlecomte.net/yuicompressor/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 10</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;yuicompressor-jar&quot;</span> <span class='na'>value=</span><span class='s'>&quot;yuicompressor-${yuicompressor-version}.jar&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 11</span>     <span class='c'>&lt;!-- какую версию jslint4java и откуда будем качать, а также, какое имя будет у получившегося jar-файла --&gt;</span>
<span class='lineno'> 12</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;jslint-version&quot;</span> <span class='na'>value=</span><span class='s'>&quot;1.2.1&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 13</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;jslint-location&quot;</span> <span class='na'>value=</span><span class='s'>&quot;http://jslint4java.googlecode.com/files/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 14</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;jslint-zip&quot;</span> <span class='na'>value=</span><span class='s'>&quot;jslint4java-${jslint-version}.zip&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 15</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;jslint-jar&quot;</span> <span class='na'>value=</span><span class='s'>&quot;jslint4java-${jslint-version}+rhino.jar&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 16</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;jslint-unzip-dir&quot;</span> <span class='na'>value=</span><span class='s'>&quot;jslint4java-${jslint-version}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 17</span>     <span class='c'>&lt;!-- откуда мы будем брать js-файлы, css-файлы, html-темплейт --&gt;</span>
<span class='lineno'> 18</span>     <span class='nt'>&lt;property</span> <span class='na'>environment=</span><span class='s'>&quot;env&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 19</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;js.src&quot;</span> <span class='na'>value=</span><span class='s'>&quot;js/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 20</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;css.src&quot;</span> <span class='na'>value=</span><span class='s'>&quot;css/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 21</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;template.name&quot;</span> <span class='na'>value=</span><span class='s'>&quot;index.html&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 22</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;template&quot;</span> <span class='na'>value=</span><span class='s'>&quot;${template.name}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 23</span>     
<span class='lineno'> 24</span> 
<span class='lineno'> 25</span>     <span class='c'>&lt;!-- и куда мы будем их все складывать --&gt;</span>
<span class='lineno'> 26</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;output.dir&quot;</span> <span class='na'>value=</span><span class='s'>&quot;build/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 27</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;js.out&quot;</span> <span class='na'>value=</span><span class='s'>&quot;${output.dir}/js/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 28</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;css.out&quot;</span> <span class='na'>value=</span><span class='s'>&quot;${output.dir}/css/&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 29</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;template.out&quot;</span> <span class='na'>value=</span><span class='s'>&quot;${output.dir}/${template.name}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 30</span> 
<span class='lineno'> 31</span>     <span class='c'>&lt;!-- порядок конкатенации js-файлов. Указанные файлы будут расположены в начале общего js-файла в указанном порядке --&gt;</span>
<span class='lineno'> 32</span>     <span class='c'>&lt;!-- все оставшиеся файлы будут присоединены в конец файла --&gt;</span>
<span class='lineno'> 33</span>     <span class='nt'>&lt;property</span> <span class='na'>name=</span><span class='s'>&quot;js-required-file-order&quot;</span> <span class='na'>value=</span><span class='s'>&quot;jquery-1.2.6.js, some_object.js&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 34</span>     
<span class='lineno'> 35</span>     <span class='c'>&lt;!-- эта задача всегда выполнится первой --&gt;</span>
<span class='lineno'> 36</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;init&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 37</span>         <span class='nt'>&lt;tstamp&gt;</span>
<span class='lineno'> 38</span>             <span class='c'>&lt;!-- запомним в качестве переменной текущее время в формате mm-hh-MM-dd-yyyy --&gt;</span>
<span class='lineno'> 39</span>             <span class='nt'>&lt;format</span> <span class='na'>property=</span><span class='s'>&quot;build-time&quot;</span> <span class='na'>pattern=</span><span class='s'>&quot;mm-hh-MM-dd-yyyy&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 40</span>         <span class='nt'>&lt;/tstamp&gt;</span>
<span class='lineno'> 41</span>         <span class='c'>&lt;!-- создаем директорию, содержащую yui compressor и jslint4java --&gt;</span>
<span class='lineno'> 42</span>         <span class='nt'>&lt;mkdir</span> <span class='na'>dir=</span><span class='s'>&quot;${tools.location}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 43</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 44</span> 
<span class='lineno'> 45</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;prepare-tools&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;init&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 46</span>         <span class='c'>&lt;!-- скачаем и распакуем jslint и yui compressor --&gt;</span>
<span class='lineno'> 47</span>         <span class='nt'>&lt;antcall</span> <span class='na'>target=</span><span class='s'>&quot;prepare-yuicompressor&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 48</span>         <span class='nt'>&lt;antcall</span> <span class='na'>target=</span><span class='s'>&quot;prepare-jslint&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 49</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 50</span> 
<span class='lineno'> 51</span>     <span class='c'>&lt;!-- скачаем и подготовим к работе jslint --&gt;</span>
<span class='lineno'> 52</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;prepare-jslint&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;check-if-jslint-exists&quot;</span> <span class='na'>unless=</span><span class='s'>&quot;jslint.exist&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 53</span>         <span class='nt'>&lt;get</span> <span class='na'>src=</span><span class='s'>&quot;${jslint-location}${jslint-zip}&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${tools.location}${jslint-zip}&quot;</span> <span class='na'>verbose=</span><span class='s'>&quot;true&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 54</span>         <span class='nt'>&lt;unzip</span> <span class='na'>src=</span><span class='s'>&quot;${tools.location}${jslint-zip}&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${tools.location}&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 55</span>         <span class='nt'>&lt;copy</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${jslint-unzip-dir}/${jslint-jar}&quot;</span> <span class='na'>todir=</span><span class='s'>&quot;${tools.location}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 56</span>         <span class='nt'>&lt;delete</span> <span class='na'>dir=</span><span class='s'>&quot;${tools.location}${jslint-unzip-dir}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 57</span>         <span class='nt'>&lt;delete</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${jslint-zip}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 58</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 59</span> 
<span class='lineno'> 60</span>     <span class='c'>&lt;!-- удостоверимся, что jslint скачан и готов к работе - эта задача выполняется непосредственно перед проверкой js-файлов --&gt;</span>
<span class='lineno'> 61</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;check-if-jslint-exists&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 62</span>         <span class='nt'>&lt;condition</span> <span class='na'>property=</span><span class='s'>&quot;jslint.exist&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 63</span>             <span class='nt'>&lt;and&gt;</span>
<span class='lineno'> 64</span>                 <span class='nt'>&lt;available</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${jslint-jar}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 65</span>             <span class='nt'>&lt;/and&gt;</span>
<span class='lineno'> 66</span>         <span class='nt'>&lt;/condition&gt;</span>
<span class='lineno'> 67</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 68</span>     
<span class='lineno'> 69</span>     <span class='c'>&lt;!-- скачаем и подготовим к работе jslint --&gt;</span>
<span class='lineno'> 70</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;prepare-yuicompressor&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;check-if-yuicompressor-exists&quot;</span> <span class='na'>unless=</span><span class='s'>&quot;yuicompressor.exist&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 71</span>         <span class='nt'>&lt;get</span> <span class='na'>src=</span><span class='s'>&quot;${yuicompressor-location}${yuicompressor-zip}&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${tools.location}${yuicompressor-zip}&quot;</span> <span class='na'>verbose=</span><span class='s'>&quot;true&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 72</span>         <span class='nt'>&lt;unzip</span> <span class='na'>src=</span><span class='s'>&quot;${tools.location}${yuicompressor-zip}&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${tools.location}&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 73</span>         <span class='nt'>&lt;copy</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${yuicompressor-unzip-dir}/build/${yuicompressor-jar}&quot;</span> <span class='na'>todir=</span><span class='s'>&quot;${tools.location}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 74</span>         <span class='nt'>&lt;delete</span> <span class='na'>dir=</span><span class='s'>&quot;${tools.location}${yuicompressor-unzip-dir}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 75</span>         <span class='nt'>&lt;delete</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${yuicompressor-zip}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 76</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 77</span> 
<span class='lineno'> 78</span>     <span class='c'>&lt;!-- удостоверимся, что jslint скачан и готов к работе - эта задача выполняется непосредственно перед сжатием js/css-файлов --&gt;</span>
<span class='lineno'> 79</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;check-if-yuicompressor-exists&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 80</span>         <span class='nt'>&lt;condition</span> <span class='na'>property=</span><span class='s'>&quot;yuicompressor.exist&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 81</span>             <span class='nt'>&lt;and&gt;</span>
<span class='lineno'> 82</span>                 <span class='nt'>&lt;available</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${yuicompressor-jar}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 83</span>             <span class='nt'>&lt;/and&gt;</span>
<span class='lineno'> 84</span>         <span class='nt'>&lt;/condition&gt;</span>
<span class='lineno'> 85</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'> 86</span>     
<span class='lineno'> 87</span>     <span class='c'>&lt;!-- валидируем javascript --&gt;</span>
<span class='lineno'> 88</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;validate-javascript&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;prepare-tools&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 89</span>         <span class='nt'>&lt;apply</span> <span class='na'>executable=</span><span class='s'>&quot;java&quot;</span> <span class='na'>parallel=</span><span class='s'>&quot;false&quot;</span> <span class='na'>failonerror=</span><span class='s'>&quot;false&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 90</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${js.src}&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 91</span>                 <span class='nt'>&lt;include</span> <span class='na'>name=</span><span class='s'>&quot;**/*.js&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 92</span>                 <span class='c'>&lt;!-- файлы библиотек тестировать не нужно, их и другие люди уже оттестировали --&gt;</span>
<span class='lineno'> 93</span>                 <span class='nt'>&lt;exclude</span> <span class='na'>name=</span><span class='s'>&quot;**/jquery-1.2.6.js&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'> 94</span>             <span class='nt'>&lt;/fileset&gt;</span>
<span class='lineno'> 95</span>             <span class='nt'>&lt;arg</span> <span class='na'>value=</span><span class='s'>&quot;-jar&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 96</span>             <span class='nt'>&lt;arg</span> <span class='na'>file=</span><span class='s'>&quot;${tools.location}${jslint-jar}&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 97</span>             <span class='nt'>&lt;arg</span> <span class='na'>value=</span><span class='s'>&quot;--bitwise&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 98</span>             <span class='nt'>&lt;arg</span> <span class='na'>value=</span><span class='s'>&quot;--browser&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'> 99</span>             <span class='nt'>&lt;arg</span> <span class='na'>value=</span><span class='s'>&quot;--undef&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'>100</span>             <span class='nt'>&lt;arg</span> <span class='na'>value=</span><span class='s'>&quot;--widget&quot;</span> <span class='nt'>/&gt;</span>
<span class='lineno'>101</span>             <span class='nt'>&lt;srcfile</span> <span class='nt'>/&gt;</span>
<span class='lineno'>102</span>         <span class='nt'>&lt;/apply&gt;</span>
<span class='lineno'>103</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'>104</span> 
<span class='lineno'>105</span>     <span class='c'>&lt;!-- сжимаем js/css-файлы --&gt;</span>
<span class='lineno'>106</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;compress&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;prepare-tools, concatenate-files&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>107</span>         <span class='nt'>&lt;apply</span> <span class='na'>executable=</span><span class='s'>&quot;java&quot;</span> <span class='na'>parallel=</span><span class='s'>&quot;false&quot;</span> <span class='na'>failonerror=</span><span class='s'>&quot;true&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${js.out}&quot;</span> <span class='na'>verbose=</span><span class='s'>&quot;true&quot;</span> <span class='na'>force=</span><span class='s'>&quot;true&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>108</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${js.out}&quot;</span> <span class='na'>includes=</span><span class='s'>&quot;*.js&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>109</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;-jar&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>110</span>             <span class='nt'>&lt;arg</span> <span class='na'>path=</span><span class='s'>&quot;${tools.location}${yuicompressor-jar}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>111</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;--line-break 8000&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>112</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;-o&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>113</span>             <span class='nt'>&lt;targetfile/&gt;</span>
<span class='lineno'>114</span>             <span class='nt'>&lt;srcfile/&gt;</span>
<span class='lineno'>115</span>             <span class='nt'>&lt;mapper</span> <span class='na'>type=</span><span class='s'>&quot;glob&quot;</span> <span class='na'>from=</span><span class='s'>&quot;*.js&quot;</span> <span class='na'>to=</span><span class='s'>&quot;*.js&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>116</span>         <span class='nt'>&lt;/apply&gt;</span>
<span class='lineno'>117</span>         <span class='nt'>&lt;apply</span> <span class='na'>executable=</span><span class='s'>&quot;java&quot;</span> <span class='na'>parallel=</span><span class='s'>&quot;false&quot;</span> <span class='na'>failonerror=</span><span class='s'>&quot;true&quot;</span> <span class='na'>dest=</span><span class='s'>&quot;${css.out}&quot;</span> <span class='na'>verbose=</span><span class='s'>&quot;true&quot;</span> <span class='na'>force=</span><span class='s'>&quot;true&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>118</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${css.out}&quot;</span> <span class='na'>includes=</span><span class='s'>&quot;*.css&quot;</span> <span class='na'>excludes=</span><span class='s'>&quot;ie_*.css&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>119</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;-jar&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>120</span>             <span class='nt'>&lt;arg</span> <span class='na'>path=</span><span class='s'>&quot;${tools.location}${yuicompressor-jar}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>121</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;--line-break 0&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>122</span>             <span class='nt'>&lt;srcfile/&gt;</span>
<span class='lineno'>123</span>             <span class='nt'>&lt;arg</span> <span class='na'>line=</span><span class='s'>&quot;-o&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>124</span>             <span class='nt'>&lt;mapper</span> <span class='na'>type=</span><span class='s'>&quot;glob&quot;</span> <span class='na'>from=</span><span class='s'>&quot;*.css&quot;</span> <span class='na'>to=</span><span class='s'>&quot;*.css&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>125</span>             <span class='nt'>&lt;targetfile/&gt;</span>
<span class='lineno'>126</span>         <span class='nt'>&lt;/apply&gt;</span>
<span class='lineno'>127</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'>128</span> 
<span class='lineno'>129</span>     <span class='c'>&lt;!-- удаляем все старые css и js файлы в темплейте, а затем вставляем ссылки на наши сжатые файлы --&gt;</span>
<span class='lineno'>130</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;update-tags&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;prepare-tools&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>131</span>         <span class='nt'>&lt;copy</span> <span class='na'>file=</span><span class='s'>&quot;${template}&quot;</span> <span class='na'>tofile=</span><span class='s'>&quot;${template.out}&quot;</span> <span class='na'>overwrite=</span><span class='s'>&quot;true&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>132</span> 
<span class='lineno'>133</span>         <span class='nt'>&lt;replaceregexp</span> <span class='na'>file=</span><span class='s'>&quot;${template.out}&quot;</span> <span class='na'>match=</span><span class='s'>&quot;&amp;lt;script\s+type=&amp;quot;text/javascript&amp;quot;\s+src=&amp;quot;[A-Za-z0-9._\-/]*&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&quot;</span> <span class='na'>flags=</span><span class='s'>&quot;igm&quot;</span> <span class='na'>replace=</span><span class='s'>&quot;&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>134</span> 
<span class='lineno'>135</span>         <span class='nt'>&lt;replaceregexp</span> <span class='na'>file=</span><span class='s'>&quot;${template.out}&quot;</span> <span class='na'>match=</span><span class='s'>&quot;(&amp;lt;script*|&amp;lt;/body&amp;gt;)&quot;</span> <span class='na'>flags=</span><span class='s'>&quot;im&quot;</span> <span class='na'>replace=</span><span class='s'>&quot;&amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;js/main-${build-time}.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;${line.separator}\1&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>136</span> 
<span class='lineno'>137</span>         <span class='nt'>&lt;replaceregexp</span> <span class='na'>file=</span><span class='s'>&quot;${template.out}&quot;</span> <span class='na'>match=</span><span class='s'>&quot;&amp;lt;link[^&amp;gt;]*href=&amp;quot;css/[^i&amp;gt;]{1}[^e&amp;gt;]{1}[^_&amp;gt;]{1}[^&amp;gt;]*/&amp;gt;&quot;</span> <span class='na'>flags=</span><span class='s'>&quot;igm&quot;</span> <span class='na'>replace=</span><span class='s'>&quot;&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>138</span> 
<span class='lineno'>139</span>         <span class='nt'>&lt;replaceregexp</span> <span class='na'>file=</span><span class='s'>&quot;${template.out}&quot;</span> <span class='na'>match=</span><span class='s'>&quot;&amp;lt;/head&amp;gt;&quot;</span> <span class='na'>flags=</span><span class='s'>&quot;im&quot;</span> <span class='na'>replace=</span><span class='s'>&quot;&amp;lt;link rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;css/main-${build-time}.css&amp;quot; type=&amp;quot;text/css&amp;quot; /&amp;gt;&amp;lt;/head&amp;gt;&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>140</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'>141</span> 
<span class='lineno'>142</span>     <span class='c'>&lt;!-- конкатенация файлов --&gt;</span>
<span class='lineno'>143</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;concatenate-files&quot;</span> <span class='na'>depends=</span><span class='s'>&quot;update-tags&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>144</span>         <span class='nt'>&lt;concat</span> <span class='na'>destfile=</span><span class='s'>&quot;${js.out}/main-${build-time}.js&quot;</span> <span class='na'>fixlastline=</span><span class='s'>&quot;true&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>145</span>             <span class='nt'>&lt;filelist</span> <span class='na'>dir=</span><span class='s'>&quot;${js.src}&quot;</span>
<span class='lineno'>146</span>                 <span class='na'>files=</span><span class='s'>&quot;${js-required-file-order}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>147</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${js.src}&quot;</span>
<span class='lineno'>148</span>                 <span class='na'>includes=</span><span class='s'>&quot;**/*.js&quot;</span>
<span class='lineno'>149</span>                 <span class='na'>excludes=</span><span class='s'>&quot;${js-required-file-order}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>150</span>         <span class='nt'>&lt;/concat&gt;</span>
<span class='lineno'>151</span> 
<span class='lineno'>152</span>         <span class='nt'>&lt;copy</span> <span class='na'>todir=</span><span class='s'>&quot;${css.out}&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>153</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${css.src}&quot;</span> <span class='na'>includes=</span><span class='s'>&quot;**/ie_*.css&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>154</span>         <span class='nt'>&lt;/copy&gt;</span>
<span class='lineno'>155</span>         <span class='nt'>&lt;concat</span> <span class='na'>destfile=</span><span class='s'>&quot;${css.out}/main-${build-time}.css&quot;</span> <span class='na'>fixlastline=</span><span class='s'>&quot;true&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>156</span>             <span class='nt'>&lt;fileset</span> <span class='na'>dir=</span><span class='s'>&quot;${css.src}&quot;</span>
<span class='lineno'>157</span>                 <span class='na'>includes=</span><span class='s'>&quot;**/*.css&quot;</span>
<span class='lineno'>158</span>                 <span class='na'>excludes=</span><span class='s'>&quot;**/ie_*.css&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>159</span>         <span class='nt'>&lt;/concat&gt;</span>
<span class='lineno'>160</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'>161</span> 
<span class='lineno'>162</span>     <span class='nt'>&lt;target</span> <span class='na'>name=</span><span class='s'>&quot;build&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'>163</span>         <span class='nt'>&lt;mkdir</span> <span class='na'>dir=</span><span class='s'>&quot;${output.dir}&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>164</span>         <span class='nt'>&lt;antcall</span> <span class='na'>target=</span><span class='s'>&quot;validate-javascript&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>165</span>         <span class='nt'>&lt;antcall</span> <span class='na'>target=</span><span class='s'>&quot;compress&quot;</span><span class='nt'>/&gt;</span>
<span class='lineno'>166</span>     <span class='nt'>&lt;/target&gt;</span>
<span class='lineno'>167</span> <span class='nt'>&lt;/project&gt;</span>
</code></pre></div>
<p>На всякий случай, <a href='/download/clientSideAuthomatisation/ant.zip'>пример</a>.</p>

<h2 id='todo'>TODO</h2>

<ol>
<li>Не слишком красивым является указание порядка конкатенации js-файлов прямо в скрипте. Гораздо лучше было бы, если бы мы писали прямо в html что-нибудь вроде . При development build&#8217;е скрипт бы заменял эту строку на несколько script-tag&#8217;ов (удобно для debug-a), а на продакшене сливал бы файлы в один в указанном порядке.</li>

<li>Скачивание файлов при помощи ant-а не сказать, чтобы очень удобное - а что, если выйдет новая версия или изменится ссылка на скачивание? Гораздо удобнее пользоваться <a href='http://maven.apache.org/'>maven</a>&#8216;ом для таких случаев. 3. Дополняйте :)</li>
</ol>
		</div>
	</div><!-- close:post -->

	<div class="post" id="post-/posts/143/143">
		<h2><a href="/posts/143/index.html" rel="bookmark" title="Мэт Шнайдер">Мэт Шнайдер</a></h2>
		<span class="date">2008 / 11 / 25</span>
		<div class="entry">
			<p>С удивлением заметил, что в рунете (да и вообще в нете) мало ссылок на Мэта Шнайдера (Matt Snider), человека, мнение которого лично мне кажется очень авторитетным в области веб-дева вообще и javascript&#8217;а в частности. В общем, рекомендую: <a href='http://mattsnider.com/'>http://mattsnider.com/</a></p>
		</div>
	</div><!-- close:post -->

	<div class="post" id="post-/posts/135/135">
		<h2><a href="/posts/135/index.html" rel="bookmark" title="Back-button problem">Back-button problem</a></h2>
		<span class="date">2008 / 11 / 24</span>
		<div class="entry">
			<p>There are plast of different problems when you creating ajax-based RIA. Most popular is, in my opinion, so called &#8216;back-button problem&#8217;.</p>

<p>Here I share my solution of this problem, hope it will help you.</p>

<p>The idea is very simple - all dynamic content on your page load by special function (I called that method <code>loadPage</code> at <code>PageFlow</code> object). This method accept hash as param, so that if user clicks on the link which <code>href</code> is anchor, and someone else invocate this method with that anchor as param, your this method will load appropriate data. Of course, we need cover case when user just came from the another page to the root of our application so that there is no one hash param and load &#8216;default&#8217; data.</p>

<p>Assume, you use <a href='http://jquery.com/'>jQuery</a> as javascript framework and you develop usual e-commerce site which has whole list of goods and details view of goods item.</p>

<p>The main object, called History, store <code>callback</code> function and can store history of location.hash changes. When hash changes (user clicks on the &#8216;forward&#8217; or &#8216;backward&#8217; button or on the links on your page) History Object will invocate callback function with <code>hash</code> as param:</p>
<div class='highlight'><pre><code class='javascript'><span class='lineno'>  1</span> <span class='cm'>/**</span>
<span class='lineno'>  2</span> <span class='cm'> * History managment, for ajax-based pages</span>
<span class='lineno'>  3</span> <span class='cm'> * @class History</span>
<span class='lineno'>  4</span> <span class='cm'> * @constructor</span>
<span class='lineno'>  5</span> <span class='cm'> */</span>
<span class='lineno'>  6</span> <span class='nx'>History</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>  7</span>    <span class='kd'>var</span>
<span class='lineno'>  8</span>    <span class='cm'>/**</span>
<span class='lineno'>  9</span> <span class='cm'>    * @property currentHash</span>
<span class='lineno'> 10</span> <span class='cm'>    * @private</span>
<span class='lineno'> 11</span> <span class='cm'>    */</span>
<span class='lineno'> 12</span>    <span class='nx'>currentHash</span><span class='p'>,</span>
<span class='lineno'> 13</span>    <span class='cm'>/**</span>
<span class='lineno'> 14</span> <span class='cm'>    * @property _callback</span>
<span class='lineno'> 15</span> <span class='cm'>    * @private</span>
<span class='lineno'> 16</span> <span class='cm'>    */</span>
<span class='lineno'> 17</span>    <span class='nx'>_callback</span><span class='p'>,</span>
<span class='lineno'> 18</span> 
<span class='lineno'> 19</span>    <span class='nx'>historyBackStack</span><span class='p'>,</span>
<span class='lineno'> 20</span> 
<span class='lineno'> 21</span>    <span class='nx'>historyForwardStack</span><span class='p'>,</span>
<span class='lineno'> 22</span> 
<span class='lineno'> 23</span>    <span class='nx'>isFirst</span><span class='p'>,</span>
<span class='lineno'> 24</span> 
<span class='lineno'> 25</span>    <span class='nx'>dontCheck</span><span class='p'>,</span>
<span class='lineno'> 26</span> 
<span class='lineno'> 27</span>    <span class='nx'>check</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'> 28</span>        <span class='kd'>var</span> <span class='nx'>i</span><span class='p'>,</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 29</span>        <span class='k'>if</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 30</span>            <span class='c1'>// On IE, check for location.hash of iframe</span>
<span class='lineno'> 31</span>            <span class='kd'>var</span> <span class='nx'>ihistory</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>];</span>
<span class='lineno'> 32</span>            <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentDocument</span> <span class='o'>||</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'> 33</span>            <span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 34</span>            <span class='k'>if</span><span class='p'>(</span><span class='nx'>hash</span> <span class='o'>!=</span> <span class='nx'>currentHash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 35</span> 
<span class='lineno'> 36</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 37</span>                <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 38</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 39</span> 
<span class='lineno'> 40</span>            <span class='p'>}</span>
<span class='lineno'> 41</span>        <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 42</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>dontCheck</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 43</span>                <span class='kd'>var</span> <span class='nx'>historyDelta</span> <span class='o'>=</span> <span class='nx'>history</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>-</span> <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span>
<span class='lineno'> 44</span> 
<span class='lineno'> 45</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>historyDelta</span><span class='p'>)</span> <span class='p'>{</span> <span class='c1'>// back or forward button has been pushed</span>
<span class='lineno'> 46</span>                    <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'> 47</span>                    <span class='k'>if</span> <span class='p'>(</span><span class='nx'>historyDelta</span> <span class='o'>&lt;</span> <span class='nx'>i</span> <span class='o'>=</span><span class='s2'>&quot; 0;&quot;</span> <span class='nx'>i</span> <span class='o'>=</span><span class='s2'>&quot; 0;&quot;</span> <span class='nx'>cachedhash</span> <span class='o'>=</span><span class='s2'>&quot; historyBackStack[historyBackStack.length&quot;</span> <span class='nx'>currenthash</span> <span class='o'>=</span><span class='s2'>&quot; location.hash;&quot;</span><span class='o'>&gt;=</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 48</span>                        <span class='nx'>_callback</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>URL</span><span class='p'>.</span><span class='nx'>split</span><span class='p'>(</span><span class='s1'>&#39;#&#39;</span><span class='p'>)[</span><span class='mi'>1</span><span class='p'>]);</span>
<span class='lineno'> 49</span>                    <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'> 50</span>                        <span class='nx'>_callback</span><span class='p'>(</span><span class='s1'>&#39;&#39;</span><span class='p'>);</span>
<span class='lineno'> 51</span>                    <span class='p'>}</span>
<span class='lineno'> 52</span>                    <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'> 53</span>                <span class='p'>}</span>
<span class='lineno'> 54</span>            <span class='p'>}</span>
<span class='lineno'> 55</span>        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'> 56</span>            <span class='c1'>// otherwise, check for location.hash</span>
<span class='lineno'> 57</span>            <span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 58</span>            <span class='k'>if</span><span class='p'>(</span><span class='nx'>hash</span> <span class='o'>!=</span> <span class='nx'>currentHash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 59</span>                <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 60</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 61</span>            <span class='p'>}</span>
<span class='lineno'> 62</span>        <span class='p'>}</span>
<span class='lineno'> 63</span>    <span class='p'>};</span>
<span class='lineno'> 64</span> 
<span class='lineno'> 65</span>    <span class='k'>return</span> <span class='p'>{</span>
<span class='lineno'> 66</span>        <span class='nx'>initialize</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>callback</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 67</span>            <span class='nx'>_callback</span> <span class='o'>=</span> <span class='nx'>callback</span><span class='p'>;</span>
<span class='lineno'> 68</span>            <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 69</span> 
<span class='lineno'> 70</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 71</span>                <span class='c1'>// To stop the callback firing twice during initilization if no hash present</span>
<span class='lineno'> 72</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>currentHash</span> <span class='o'>==</span> <span class='s1'>&#39;&#39;</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 73</span>                    <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='s1'>&#39;#&#39;</span><span class='p'>;</span>
<span class='lineno'> 74</span>                <span class='p'>}</span>
<span class='lineno'> 75</span> 
<span class='lineno'> 76</span>                <span class='c1'>// add hidden iframe for IE</span>
<span class='lineno'> 77</span>                <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;body&quot;</span><span class='p'>).</span><span class='nx'>prepend</span><span class='p'>(</span><span class='s1'>&#39;&lt;iframe id=&quot;APHistory&quot; style=&quot;display: none;&quot;&gt;&lt;/iframe&gt;&#39;</span><span class='p'>);</span>
<span class='lineno'> 78</span>                <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'> 79</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>open</span><span class='p'>();</span>
<span class='lineno'> 80</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>close</span><span class='p'>();</span>
<span class='lineno'> 81</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>currentHash</span><span class='p'>;</span>
<span class='lineno'> 82</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 83</span>                <span class='c1'>// etablish back/forward stacks</span>
<span class='lineno'> 84</span> 
<span class='lineno'> 85</span>                <span class='nx'>historyBackStack</span> <span class='o'>=</span> <span class='p'>[];</span>
<span class='lineno'> 86</span>                <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>=</span> <span class='nx'>history</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span>
<span class='lineno'> 87</span>                <span class='nx'>historyForwardStack</span> <span class='o'>=</span> <span class='p'>[];</span>
<span class='lineno'> 88</span>                <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'> 89</span>                <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'> 90</span>            <span class='p'>}</span>
<span class='lineno'> 91</span>            <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>currentHash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 92</span>            <span class='nx'>setInterval</span><span class='p'>(</span><span class='nx'>check</span><span class='p'>,</span> <span class='mi'>100</span><span class='p'>);</span>
<span class='lineno'> 93</span>        <span class='p'>},</span>
<span class='lineno'> 94</span> 
<span class='lineno'> 95</span>        <span class='nx'>add</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>hash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 96</span>            <span class='c1'>// This makes the looping function do something</span>
<span class='lineno'> 97</span>            <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>push</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'> 98</span> 
<span class='lineno'> 99</span>            <span class='nx'>historyForwardStack</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='c1'>// clear forwardStack (true click occured)</span>
<span class='lineno'>100</span>            <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'>101</span>        <span class='p'>},</span>
<span class='lineno'>102</span> 
<span class='lineno'>103</span>        <span class='cm'>/**</span>
<span class='lineno'>104</span> <span class='cm'>        *</span>
<span class='lineno'>105</span> <span class='cm'>        * @param hash {String} desiring hash without first #</span>
<span class='lineno'>106</span> <span class='cm'>        */</span>
<span class='lineno'>107</span>        <span class='nx'>load</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>108</span>            <span class='kd'>var</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>109</span> 
<span class='lineno'>110</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>111</span>                <span class='nx'>newhash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'>112</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>113</span>                <span class='nx'>newhash</span> <span class='o'>=</span> <span class='s1'>&#39;#&#39;</span> <span class='o'>+</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'>114</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>115</span>            <span class='p'>}</span>
<span class='lineno'>116</span>            <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>117</span> 
<span class='lineno'>118</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>119</span>                <span class='kd'>var</span> <span class='nx'>ihistory</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>];</span> <span class='c1'>// TODO: need contentDocument?</span>
<span class='lineno'>120</span>                <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'>121</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>open</span><span class='p'>();</span>
<span class='lineno'>122</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>close</span><span class='p'>();</span>
<span class='lineno'>123</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>124</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>125</span>            <span class='p'>}</span>
<span class='lineno'>126</span>            <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>127</span>                <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'>128</span>                <span class='c1'>// Manually keep track of the history values for Safari</span>
<span class='lineno'>129</span>                <span class='k'>this</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>130</span> 
<span class='lineno'>131</span>                <span class='c1'>// Wait a while before allowing checking so that Safari has time to update the &quot;history&quot; object</span>
<span class='lineno'>132</span>                <span class='c1'>// correctly (otherwise the check loop would detect a false change in hash).</span>
<span class='lineno'>133</span>                <span class='kd'>var</span> <span class='nx'>fn</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span><span class='nx'>AP</span><span class='p'>.</span><span class='nx'>History</span><span class='p'>.</span><span class='nx'>setCheck</span><span class='p'>(</span><span class='kc'>false</span><span class='p'>);};</span>
<span class='lineno'>134</span> 
<span class='lineno'>135</span>                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>fn</span><span class='p'>,</span> <span class='mi'>200</span><span class='p'>);</span>
<span class='lineno'>136</span> 
<span class='lineno'>137</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>138</span>                <span class='c1'>// N.B. &quot;location.hash=&quot; must be the last line of code for Safari as execution stops afterwards.</span>
<span class='lineno'>139</span>                <span class='c1'>//      By explicitly using the &quot;location.hash&quot; command (instead of using a variable set to &quot;location.hash&quot;) the</span>
<span class='lineno'>140</span>                <span class='c1'>//      URL in the browser and the &quot;history&quot; object are both updated correctly.</span>
<span class='lineno'>141</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>142</span>            <span class='p'>}</span>
<span class='lineno'>143</span>            <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>144</span>              <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>145</span>            <span class='p'>}</span>
<span class='lineno'>146</span>        <span class='p'>},</span>
<span class='lineno'>147</span> 
<span class='lineno'>148</span>        <span class='cm'>/**</span>
<span class='lineno'>149</span> <span class='cm'>        * Set need we check, or not.</span>
<span class='lineno'>150</span> <span class='cm'>        * @param check {Boolean}</span>
<span class='lineno'>151</span> <span class='cm'>        * @protected</span>
<span class='lineno'>152</span> <span class='cm'>        */</span>
<span class='lineno'>153</span>        <span class='nx'>setCheck</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>check</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>154</span>            <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='nx'>check</span><span class='p'>;</span>
<span class='lineno'>155</span>        <span class='p'>},</span>
<span class='lineno'>156</span> 
<span class='lineno'>157</span>        <span class='cm'>/**</span>
<span class='lineno'>158</span> <span class='cm'>        * @method getCurrentHash</span>
<span class='lineno'>159</span> <span class='cm'>        * @return {String}</span>
<span class='lineno'>160</span> <span class='cm'>        */</span>
<span class='lineno'>161</span>        <span class='nx'>getCurrentHash</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>162</span>            <span class='k'>return</span> <span class='nx'>currentHash</span><span class='p'>;</span>
<span class='lineno'>163</span>        <span class='p'>}</span>
<span class='lineno'>164</span>    <span class='p'>};</span>
<span class='lineno'>165</span> <span class='p'>}();</span>
</code></pre></div>
<p>PageFlow object, that I describe above looks like this:</p>
<div class='highlight'><pre><code class='javascript'><span class='lineno'> 1</span> <span class='cm'>/**</span>
<span class='lineno'> 2</span> <span class='cm'> * Page Flow controller - load hash-specific data, show appropriate container and all that</span>
<span class='lineno'> 3</span> <span class='cm'> * @Class PageFlow</span>
<span class='lineno'> 4</span> <span class='cm'> */</span>
<span class='lineno'> 5</span> <span class='kd'>var</span> <span class='nx'>PageFlow</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'> 6</span>    <span class='cm'>/**</span>
<span class='lineno'> 7</span> <span class='cm'>    * show whole list of goods</span>
<span class='lineno'> 8</span> <span class='cm'>    * @method loadListOfGoods</span>
<span class='lineno'> 9</span> <span class='cm'>    * @private</span>
<span class='lineno'>10</span> <span class='cm'>    */</span>
<span class='lineno'>11</span>    <span class='nx'>loadListOfGoods</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>12</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#goodsItemDetails&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;none&#39;</span><span class='p'>);</span>
<span class='lineno'>13</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#listOfGoodsWorkArea&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;block&#39;</span><span class='p'>);</span>
<span class='lineno'>14</span>    <span class='p'>},</span>
<span class='lineno'>15</span>    <span class='cm'>/**</span>
<span class='lineno'>16</span> <span class='cm'>    * show detailed goods item view</span>
<span class='lineno'>17</span> <span class='cm'>    * @method loadGoodsItemDetails</span>
<span class='lineno'>18</span> <span class='cm'>    * @private</span>
<span class='lineno'>19</span> <span class='cm'>    */</span>
<span class='lineno'>20</span>    <span class='nx'>loadGoodsItemDetails</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>id</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>21</span>        <span class='kd'>var</span> <span class='nx'>item</span> <span class='o'>=</span> <span class='nx'>M</span><span class='p'>.</span><span class='nx'>ListOfGoods</span><span class='p'>.</span><span class='nx'>getGoodsItemById</span><span class='p'>(</span><span class='nx'>id</span><span class='p'>);</span>
<span class='lineno'>22</span>        <span class='k'>if</span> <span class='p'>(</span><span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedProfit</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>23</span>            <span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedProfit</span> <span class='o'>=</span> <span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedPrice</span><span class='p'>;</span>
<span class='lineno'>24</span>        <span class='p'>}</span>
<span class='lineno'>25</span>        <span class='c1'>// fill container with appropriate data</span>
<span class='lineno'>26</span>        <span class='nx'>M</span><span class='p'>.</span><span class='nx'>Renderer</span><span class='p'>.</span><span class='nx'>renderGoodsItemDetails</span><span class='p'>([</span><span class='nx'>item</span><span class='p'>]);</span>
<span class='lineno'>27</span>        <span class='c1'>// show goodsItemDetails</span>
<span class='lineno'>28</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#goodsItemDetails&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;block&#39;</span><span class='p'>);</span>
<span class='lineno'>29</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#listOfGoodsWorkArea&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;none&#39;</span><span class='p'>);</span>
<span class='lineno'>30</span>    <span class='p'>},</span>
<span class='lineno'>31</span> 
<span class='lineno'>32</span>    <span class='k'>return</span> <span class='p'>{</span>
<span class='lineno'>33</span>        <span class='cm'>/**</span>
<span class='lineno'>34</span> <span class='cm'>        * decide what page to load</span>
<span class='lineno'>35</span> <span class='cm'>        * @method loadPage</span>
<span class='lineno'>36</span> <span class='cm'>        * @param pageName {String|Number} location.hash with stripped `#` sign</span>
<span class='lineno'>37</span> <span class='cm'>        * @public</span>
<span class='lineno'>38</span> <span class='cm'>        */</span>
<span class='lineno'>39</span>        <span class='nx'>loadPage</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>40</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>isUndefined</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>))</span> <span class='p'>{</span>
<span class='lineno'>41</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>M</span><span class='p'>.</span><span class='nx'>ClientURI</span><span class='p'>.</span><span class='nx'>isMainPage</span><span class='p'>())</span> <span class='p'>{</span>
<span class='lineno'>42</span>                    <span class='nx'>loadListOfGoods</span><span class='p'>();</span>
<span class='lineno'>43</span>                <span class='p'>}</span>
<span class='lineno'>44</span>            <span class='p'>}</span>
<span class='lineno'>45</span>            <span class='c1'>// if pageName is number</span>
<span class='lineno'>46</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>isNumber</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='o'>||</span> <span class='nx'>pageName</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/\d+/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>).</span><span class='nx'>length</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>47</span>                <span class='c1'>// need to load goods item details page with provided id</span>
<span class='lineno'>48</span>                <span class='nx'>loadGoodsItemDetails</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>);</span>
<span class='lineno'>49</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>50</span>                <span class='k'>switch</span> <span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>51</span>                    <span class='k'>case</span> <span class='s1'>&#39;all&#39;</span><span class='o'>:</span>
<span class='lineno'>52</span>                        <span class='nx'>loadListOfGoods</span><span class='p'>();</span>
<span class='lineno'>53</span>                        <span class='k'>break</span><span class='p'>;</span>
<span class='lineno'>54</span>                <span class='p'>}</span>
<span class='lineno'>55</span>            <span class='p'>}</span>
<span class='lineno'>56</span>        <span class='p'>}</span>
<span class='lineno'>57</span>    <span class='p'>};</span>
<span class='lineno'>58</span> <span class='p'>}();</span>
</code></pre></div>
<p>That is almost the end, only two things left:</p>

<ol>
<li>initialize <code>History</code> object with <code>loadPage</code> method of <code>PageFlow</code> object</li>

<li>change default behavior of the links - they must invocate <code>load</code> method of <code>History</code> object instead of send user to anchor location area</li>
</ol>
<div class='highlight'><pre><code class='javascript'><span class='lineno'>1</span> <span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>2</span>    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;a @rel=[history]&#39;</span><span class='p'>).</span><span class='nx'>click</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>3</span>        <span class='nx'>History</span><span class='p'>.</span><span class='nx'>load</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>href</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^.*#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'>4</span>        <span class='k'>return</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'>5</span>    <span class='p'>});</span>
<span class='lineno'>6</span> 
<span class='lineno'>7</span>    <span class='nx'>History</span><span class='p'>.</span><span class='nx'>initialize</span><span class='p'>(</span><span class='nx'>PageFlow</span><span class='p'>.</span><span class='nx'>loadPage</span><span class='p'>);</span>
<span class='lineno'>8</span> <span class='p'>});</span>
</code></pre></div>
		</div>
	</div><!-- close:post -->

<div class="pagination clearfix">
    
    		
    		    <div class="prev"><a href="/page8/">&laquo; Newer</a></div>
    		

    		
    		    <div class="next"><a href="/page10/">Older &raquo;</a></div>
    		
    
</div>
	
    
		</div><!-- close:main-content -->
		<div id="sidebar" class="clearfix">
    <div id="sb-1">
        <a href="/about.html">About</a>
        <ul id="rss">
            <li><a href="http://feeds.feedburner.com/ulizko-com">RSS Feed of the articles</a></li>
        </ul>
    </div>
	<div id="sb-2">
		<a href="mailto:alexander@ulizko.com" class="email">alexander@ulizko.com</a>
		<br />
		<a href="http://twitter.com/aulizko" class="twitter">@aulizko</a>
		<br />
		<a href="http://http://www.facebook.com/profile.php?id=1002139259" class="facebook">Alexander Ulizko</a>
		<br />
		<a href="http://github.com/aulizko">github</a>
		<br />
		<a href="https://code.google.com/u/aulizko/">Google Code</a>
	</div><!-- close:sb-2 -->
</div><!-- close:sidebar -->
	    </div><!-- close:content -->
<div id="footer">
    <p>&copy;2008&nbsp;&mdash;&nbsp;2014 <a href="http://ulizko.com">Alexander Ulizko</a></p>
	<p>Powered by <a href="https://pages.github.com/">Github Pages</a> | generated by <a href="https://github.com/mojombo/jekyll">jekyll</a> | powered by <a href="http://disqus.com">disqus</a> | themed by <a href="http://www.vostoktheme.com" hreflang="en">Vostok Theme</a></p>
</div><!-- close:footer -->
</div><!-- close:wrapper -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4326533-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>