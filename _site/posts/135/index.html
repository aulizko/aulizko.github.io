<!DOCTYPE html>
<html lang="en">
<head>
	<title>Back-button problem</title>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" />
</head>
<body>
<div id="wrapper">
	<div id="header">
    	<h1><a href="/">Alexander's Ulizko blog</a></h1>
	</div><!-- close:header -->
    <div id="content">
		<div id="main-content">

			<div class="post" id="post-">
				<h2>Back-button problem</h2>
				<span class="date"></span>
				<div class="entry">
					<p>There are plast of different problems when you creating ajax-based RIA. Most popular is, in my opinion, so called &#8216;back-button problem&#8217;.</p>

<p>Here I share my solution of this problem, hope it will help you.</p>

<p>The idea is very simple - all dynamic content on your page load by special function (I called that method <code>loadPage</code> at <code>PageFlow</code> object). This method accept hash as param, so that if user clicks on the link which <code>href</code> is anchor, and someone else invocate this method with that anchor as param, your this method will load appropriate data. Of course, we need cover case when user just came from the another page to the root of our application so that there is no one hash param and load &#8216;default&#8217; data.</p>

<p>Assume, you use <a href='http://jquery.com/'>jQuery</a> as javascript framework and you develop usual e-commerce site which has whole list of goods and details view of goods item.</p>

<p>The main object, called History, store <code>callback</code> function and can store history of location.hash changes. When hash changes (user clicks on the &#8216;forward&#8217; or &#8216;backward&#8217; button or on the links on your page) History Object will invocate callback function with <code>hash</code> as param:</p>
<div class='highlight'><pre><code class='javascript'><span class='lineno'>  1</span> <span class='cm'>/**</span>
<span class='lineno'>  2</span> <span class='cm'> * History managment, for ajax-based pages</span>
<span class='lineno'>  3</span> <span class='cm'> * @class History</span>
<span class='lineno'>  4</span> <span class='cm'> * @constructor</span>
<span class='lineno'>  5</span> <span class='cm'> */</span>
<span class='lineno'>  6</span> <span class='nx'>History</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>  7</span>    <span class='kd'>var</span>
<span class='lineno'>  8</span>    <span class='cm'>/**</span>
<span class='lineno'>  9</span> <span class='cm'>    * @property currentHash</span>
<span class='lineno'> 10</span> <span class='cm'>    * @private</span>
<span class='lineno'> 11</span> <span class='cm'>    */</span>
<span class='lineno'> 12</span>    <span class='nx'>currentHash</span><span class='p'>,</span>
<span class='lineno'> 13</span>    <span class='cm'>/**</span>
<span class='lineno'> 14</span> <span class='cm'>    * @property _callback</span>
<span class='lineno'> 15</span> <span class='cm'>    * @private</span>
<span class='lineno'> 16</span> <span class='cm'>    */</span>
<span class='lineno'> 17</span>    <span class='nx'>_callback</span><span class='p'>,</span>
<span class='lineno'> 18</span> 
<span class='lineno'> 19</span>    <span class='nx'>historyBackStack</span><span class='p'>,</span>
<span class='lineno'> 20</span> 
<span class='lineno'> 21</span>    <span class='nx'>historyForwardStack</span><span class='p'>,</span>
<span class='lineno'> 22</span> 
<span class='lineno'> 23</span>    <span class='nx'>isFirst</span><span class='p'>,</span>
<span class='lineno'> 24</span> 
<span class='lineno'> 25</span>    <span class='nx'>dontCheck</span><span class='p'>,</span>
<span class='lineno'> 26</span> 
<span class='lineno'> 27</span>    <span class='nx'>check</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'> 28</span>        <span class='kd'>var</span> <span class='nx'>i</span><span class='p'>,</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 29</span>        <span class='k'>if</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 30</span>            <span class='c1'>// On IE, check for location.hash of iframe</span>
<span class='lineno'> 31</span>            <span class='kd'>var</span> <span class='nx'>ihistory</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>];</span>
<span class='lineno'> 32</span>            <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentDocument</span> <span class='o'>||</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'> 33</span>            <span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 34</span>            <span class='k'>if</span><span class='p'>(</span><span class='nx'>hash</span> <span class='o'>!=</span> <span class='nx'>currentHash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 35</span> 
<span class='lineno'> 36</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 37</span>                <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 38</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 39</span> 
<span class='lineno'> 40</span>            <span class='p'>}</span>
<span class='lineno'> 41</span>        <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 42</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>dontCheck</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 43</span>                <span class='kd'>var</span> <span class='nx'>historyDelta</span> <span class='o'>=</span> <span class='nx'>history</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>-</span> <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span>
<span class='lineno'> 44</span> 
<span class='lineno'> 45</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>historyDelta</span><span class='p'>)</span> <span class='p'>{</span> <span class='c1'>// back or forward button has been pushed</span>
<span class='lineno'> 46</span>                    <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'> 47</span>                    <span class='k'>if</span> <span class='p'>(</span><span class='nx'>historyDelta</span> <span class='o'>&lt;</span> <span class='nx'>i</span> <span class='o'>=</span><span class='s2'>&quot; 0;&quot;</span> <span class='nx'>i</span> <span class='o'>=</span><span class='s2'>&quot; 0;&quot;</span> <span class='nx'>cachedhash</span> <span class='o'>=</span><span class='s2'>&quot; historyBackStack[historyBackStack.length&quot;</span> <span class='nx'>currenthash</span> <span class='o'>=</span><span class='s2'>&quot; location.hash;&quot;</span><span class='o'>&gt;=</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 48</span>                        <span class='nx'>_callback</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>URL</span><span class='p'>.</span><span class='nx'>split</span><span class='p'>(</span><span class='s1'>&#39;#&#39;</span><span class='p'>)[</span><span class='mi'>1</span><span class='p'>]);</span>
<span class='lineno'> 49</span>                    <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'> 50</span>                        <span class='nx'>_callback</span><span class='p'>(</span><span class='s1'>&#39;&#39;</span><span class='p'>);</span>
<span class='lineno'> 51</span>                    <span class='p'>}</span>
<span class='lineno'> 52</span>                    <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'> 53</span>                <span class='p'>}</span>
<span class='lineno'> 54</span>            <span class='p'>}</span>
<span class='lineno'> 55</span>        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'> 56</span>            <span class='c1'>// otherwise, check for location.hash</span>
<span class='lineno'> 57</span>            <span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 58</span>            <span class='k'>if</span><span class='p'>(</span><span class='nx'>hash</span> <span class='o'>!=</span> <span class='nx'>currentHash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 59</span>                <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 60</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 61</span>            <span class='p'>}</span>
<span class='lineno'> 62</span>        <span class='p'>}</span>
<span class='lineno'> 63</span>    <span class='p'>};</span>
<span class='lineno'> 64</span> 
<span class='lineno'> 65</span>    <span class='k'>return</span> <span class='p'>{</span>
<span class='lineno'> 66</span>        <span class='nx'>initialize</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>callback</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 67</span>            <span class='nx'>_callback</span> <span class='o'>=</span> <span class='nx'>callback</span><span class='p'>;</span>
<span class='lineno'> 68</span>            <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'> 69</span> 
<span class='lineno'> 70</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 71</span>                <span class='c1'>// To stop the callback firing twice during initilization if no hash present</span>
<span class='lineno'> 72</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>currentHash</span> <span class='o'>==</span> <span class='s1'>&#39;&#39;</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 73</span>                    <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='s1'>&#39;#&#39;</span><span class='p'>;</span>
<span class='lineno'> 74</span>                <span class='p'>}</span>
<span class='lineno'> 75</span> 
<span class='lineno'> 76</span>                <span class='c1'>// add hidden iframe for IE</span>
<span class='lineno'> 77</span>                <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;body&quot;</span><span class='p'>).</span><span class='nx'>prepend</span><span class='p'>(</span><span class='s1'>&#39;&lt;iframe id=&quot;APHistory&quot; style=&quot;display: none;&quot;&gt;&lt;/iframe&gt;&#39;</span><span class='p'>);</span>
<span class='lineno'> 78</span>                <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'> 79</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>open</span><span class='p'>();</span>
<span class='lineno'> 80</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>close</span><span class='p'>();</span>
<span class='lineno'> 81</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>currentHash</span><span class='p'>;</span>
<span class='lineno'> 82</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 83</span>                <span class='c1'>// etablish back/forward stacks</span>
<span class='lineno'> 84</span> 
<span class='lineno'> 85</span>                <span class='nx'>historyBackStack</span> <span class='o'>=</span> <span class='p'>[];</span>
<span class='lineno'> 86</span>                <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>=</span> <span class='nx'>history</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span>
<span class='lineno'> 87</span>                <span class='nx'>historyForwardStack</span> <span class='o'>=</span> <span class='p'>[];</span>
<span class='lineno'> 88</span>                <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'> 89</span>                <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'> 90</span>            <span class='p'>}</span>
<span class='lineno'> 91</span>            <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>currentHash</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'> 92</span>            <span class='nx'>setInterval</span><span class='p'>(</span><span class='nx'>check</span><span class='p'>,</span> <span class='mi'>100</span><span class='p'>);</span>
<span class='lineno'> 93</span>        <span class='p'>},</span>
<span class='lineno'> 94</span> 
<span class='lineno'> 95</span>        <span class='nx'>add</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>hash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'> 96</span>            <span class='c1'>// This makes the looping function do something</span>
<span class='lineno'> 97</span>            <span class='nx'>historyBackStack</span><span class='p'>.</span><span class='nx'>push</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'> 98</span> 
<span class='lineno'> 99</span>            <span class='nx'>historyForwardStack</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='c1'>// clear forwardStack (true click occured)</span>
<span class='lineno'>100</span>            <span class='nx'>isFirst</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'>101</span>        <span class='p'>},</span>
<span class='lineno'>102</span> 
<span class='lineno'>103</span>        <span class='cm'>/**</span>
<span class='lineno'>104</span> <span class='cm'>        *</span>
<span class='lineno'>105</span> <span class='cm'>        * @param hash {String} desiring hash without first #</span>
<span class='lineno'>106</span> <span class='cm'>        */</span>
<span class='lineno'>107</span>        <span class='nx'>load</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>108</span>            <span class='kd'>var</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>109</span> 
<span class='lineno'>110</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>111</span>                <span class='nx'>newhash</span> <span class='o'>=</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'>112</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>113</span>                <span class='nx'>newhash</span> <span class='o'>=</span> <span class='s1'>&#39;#&#39;</span> <span class='o'>+</span> <span class='nx'>hash</span><span class='p'>;</span>
<span class='lineno'>114</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>115</span>            <span class='p'>}</span>
<span class='lineno'>116</span>            <span class='nx'>currentHash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>117</span> 
<span class='lineno'>118</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>msie</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>119</span>                <span class='kd'>var</span> <span class='nx'>ihistory</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;#APHistory&quot;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>];</span> <span class='c1'>// TODO: need contentDocument?</span>
<span class='lineno'>120</span>                <span class='kd'>var</span> <span class='nx'>iframe</span> <span class='o'>=</span> <span class='nx'>ihistory</span><span class='p'>.</span><span class='nx'>contentWindow</span><span class='p'>.</span><span class='nb'>document</span><span class='p'>;</span>
<span class='lineno'>121</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>open</span><span class='p'>();</span>
<span class='lineno'>122</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>close</span><span class='p'>();</span>
<span class='lineno'>123</span>                <span class='nx'>iframe</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>124</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>125</span>            <span class='p'>}</span>
<span class='lineno'>126</span>            <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>$</span><span class='p'>.</span><span class='nx'>browser</span><span class='p'>.</span><span class='nx'>safari</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>127</span>                <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
<span class='lineno'>128</span>                <span class='c1'>// Manually keep track of the history values for Safari</span>
<span class='lineno'>129</span>                <span class='k'>this</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>130</span> 
<span class='lineno'>131</span>                <span class='c1'>// Wait a while before allowing checking so that Safari has time to update the &quot;history&quot; object</span>
<span class='lineno'>132</span>                <span class='c1'>// correctly (otherwise the check loop would detect a false change in hash).</span>
<span class='lineno'>133</span>                <span class='kd'>var</span> <span class='nx'>fn</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span><span class='nx'>AP</span><span class='p'>.</span><span class='nx'>History</span><span class='p'>.</span><span class='nx'>setCheck</span><span class='p'>(</span><span class='kc'>false</span><span class='p'>);};</span>
<span class='lineno'>134</span> 
<span class='lineno'>135</span>                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>fn</span><span class='p'>,</span> <span class='mi'>200</span><span class='p'>);</span>
<span class='lineno'>136</span> 
<span class='lineno'>137</span>                <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>138</span>                <span class='c1'>// N.B. &quot;location.hash=&quot; must be the last line of code for Safari as execution stops afterwards.</span>
<span class='lineno'>139</span>                <span class='c1'>//      By explicitly using the &quot;location.hash&quot; command (instead of using a variable set to &quot;location.hash&quot;) the</span>
<span class='lineno'>140</span>                <span class='c1'>//      URL in the browser and the &quot;history&quot; object are both updated correctly.</span>
<span class='lineno'>141</span>                <span class='nx'>location</span><span class='p'>.</span><span class='nx'>hash</span> <span class='o'>=</span> <span class='nx'>newhash</span><span class='p'>;</span>
<span class='lineno'>142</span>            <span class='p'>}</span>
<span class='lineno'>143</span>            <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>144</span>              <span class='nx'>_callback</span><span class='p'>(</span><span class='nx'>hash</span><span class='p'>);</span>
<span class='lineno'>145</span>            <span class='p'>}</span>
<span class='lineno'>146</span>        <span class='p'>},</span>
<span class='lineno'>147</span> 
<span class='lineno'>148</span>        <span class='cm'>/**</span>
<span class='lineno'>149</span> <span class='cm'>        * Set need we check, or not.</span>
<span class='lineno'>150</span> <span class='cm'>        * @param check {Boolean}</span>
<span class='lineno'>151</span> <span class='cm'>        * @protected</span>
<span class='lineno'>152</span> <span class='cm'>        */</span>
<span class='lineno'>153</span>        <span class='nx'>setCheck</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>check</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>154</span>            <span class='nx'>dontCheck</span> <span class='o'>=</span> <span class='nx'>check</span><span class='p'>;</span>
<span class='lineno'>155</span>        <span class='p'>},</span>
<span class='lineno'>156</span> 
<span class='lineno'>157</span>        <span class='cm'>/**</span>
<span class='lineno'>158</span> <span class='cm'>        * @method getCurrentHash</span>
<span class='lineno'>159</span> <span class='cm'>        * @return {String}</span>
<span class='lineno'>160</span> <span class='cm'>        */</span>
<span class='lineno'>161</span>        <span class='nx'>getCurrentHash</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>162</span>            <span class='k'>return</span> <span class='nx'>currentHash</span><span class='p'>;</span>
<span class='lineno'>163</span>        <span class='p'>}</span>
<span class='lineno'>164</span>    <span class='p'>};</span>
<span class='lineno'>165</span> <span class='p'>}();</span>
</code></pre></div>
<p>PageFlow object, that I describe above looks like this:</p>
<div class='highlight'><pre><code class='javascript'><span class='lineno'> 1</span> <span class='cm'>/**</span>
<span class='lineno'> 2</span> <span class='cm'> * Page Flow controller - load hash-specific data, show appropriate container and all that</span>
<span class='lineno'> 3</span> <span class='cm'> * @Class PageFlow</span>
<span class='lineno'> 4</span> <span class='cm'> */</span>
<span class='lineno'> 5</span> <span class='kd'>var</span> <span class='nx'>PageFlow</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'> 6</span>    <span class='cm'>/**</span>
<span class='lineno'> 7</span> <span class='cm'>    * show whole list of goods</span>
<span class='lineno'> 8</span> <span class='cm'>    * @method loadListOfGoods</span>
<span class='lineno'> 9</span> <span class='cm'>    * @private</span>
<span class='lineno'>10</span> <span class='cm'>    */</span>
<span class='lineno'>11</span>    <span class='nx'>loadListOfGoods</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>12</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#goodsItemDetails&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;none&#39;</span><span class='p'>);</span>
<span class='lineno'>13</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#listOfGoodsWorkArea&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;block&#39;</span><span class='p'>);</span>
<span class='lineno'>14</span>    <span class='p'>},</span>
<span class='lineno'>15</span>    <span class='cm'>/**</span>
<span class='lineno'>16</span> <span class='cm'>    * show detailed goods item view</span>
<span class='lineno'>17</span> <span class='cm'>    * @method loadGoodsItemDetails</span>
<span class='lineno'>18</span> <span class='cm'>    * @private</span>
<span class='lineno'>19</span> <span class='cm'>    */</span>
<span class='lineno'>20</span>    <span class='nx'>loadGoodsItemDetails</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>id</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>21</span>        <span class='kd'>var</span> <span class='nx'>item</span> <span class='o'>=</span> <span class='nx'>M</span><span class='p'>.</span><span class='nx'>ListOfGoods</span><span class='p'>.</span><span class='nx'>getGoodsItemById</span><span class='p'>(</span><span class='nx'>id</span><span class='p'>);</span>
<span class='lineno'>22</span>        <span class='k'>if</span> <span class='p'>(</span><span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedProfit</span><span class='p'>.</span><span class='nx'>length</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>23</span>            <span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedProfit</span> <span class='o'>=</span> <span class='nx'>item</span><span class='p'>.</span><span class='nx'>pluralizedPrice</span><span class='p'>;</span>
<span class='lineno'>24</span>        <span class='p'>}</span>
<span class='lineno'>25</span>        <span class='c1'>// fill container with appropriate data</span>
<span class='lineno'>26</span>        <span class='nx'>M</span><span class='p'>.</span><span class='nx'>Renderer</span><span class='p'>.</span><span class='nx'>renderGoodsItemDetails</span><span class='p'>([</span><span class='nx'>item</span><span class='p'>]);</span>
<span class='lineno'>27</span>        <span class='c1'>// show goodsItemDetails</span>
<span class='lineno'>28</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#goodsItemDetails&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;block&#39;</span><span class='p'>);</span>
<span class='lineno'>29</span>        <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#listOfGoodsWorkArea&#39;</span><span class='p'>).</span><span class='nx'>css</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;none&#39;</span><span class='p'>);</span>
<span class='lineno'>30</span>    <span class='p'>},</span>
<span class='lineno'>31</span> 
<span class='lineno'>32</span>    <span class='k'>return</span> <span class='p'>{</span>
<span class='lineno'>33</span>        <span class='cm'>/**</span>
<span class='lineno'>34</span> <span class='cm'>        * decide what page to load</span>
<span class='lineno'>35</span> <span class='cm'>        * @method loadPage</span>
<span class='lineno'>36</span> <span class='cm'>        * @param pageName {String|Number} location.hash with stripped `#` sign</span>
<span class='lineno'>37</span> <span class='cm'>        * @public</span>
<span class='lineno'>38</span> <span class='cm'>        */</span>
<span class='lineno'>39</span>        <span class='nx'>loadPage</span> <span class='o'>:</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>40</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>isUndefined</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>))</span> <span class='p'>{</span>
<span class='lineno'>41</span>                <span class='k'>if</span> <span class='p'>(</span><span class='nx'>M</span><span class='p'>.</span><span class='nx'>ClientURI</span><span class='p'>.</span><span class='nx'>isMainPage</span><span class='p'>())</span> <span class='p'>{</span>
<span class='lineno'>42</span>                    <span class='nx'>loadListOfGoods</span><span class='p'>();</span>
<span class='lineno'>43</span>                <span class='p'>}</span>
<span class='lineno'>44</span>            <span class='p'>}</span>
<span class='lineno'>45</span>            <span class='c1'>// if pageName is number</span>
<span class='lineno'>46</span>            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>isNumber</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='o'>||</span> <span class='nx'>pageName</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/\d+/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>).</span><span class='nx'>length</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>47</span>                <span class='c1'>// need to load goods item details page with provided id</span>
<span class='lineno'>48</span>                <span class='nx'>loadGoodsItemDetails</span><span class='p'>(</span><span class='nx'>pageName</span><span class='p'>);</span>
<span class='lineno'>49</span>            <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
<span class='lineno'>50</span>                <span class='k'>switch</span> <span class='p'>(</span><span class='nx'>pageName</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>51</span>                    <span class='k'>case</span> <span class='s1'>&#39;all&#39;</span><span class='o'>:</span>
<span class='lineno'>52</span>                        <span class='nx'>loadListOfGoods</span><span class='p'>();</span>
<span class='lineno'>53</span>                        <span class='k'>break</span><span class='p'>;</span>
<span class='lineno'>54</span>                <span class='p'>}</span>
<span class='lineno'>55</span>            <span class='p'>}</span>
<span class='lineno'>56</span>        <span class='p'>}</span>
<span class='lineno'>57</span>    <span class='p'>};</span>
<span class='lineno'>58</span> <span class='p'>}();</span>
</code></pre></div>
<p>That is almost the end, only two things left:</p>

<ol>
<li>initialize <code>History</code> object with <code>loadPage</code> method of <code>PageFlow</code> object</li>

<li>change default behavior of the links - they must invocate <code>load</code> method of <code>History</code> object instead of send user to anchor location area</li>
</ol>
<div class='highlight'><pre><code class='javascript'><span class='lineno'>1</span> <span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>2</span>    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;a @rel=[history]&#39;</span><span class='p'>).</span><span class='nx'>click</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
<span class='lineno'>3</span>        <span class='nx'>History</span><span class='p'>.</span><span class='nx'>load</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>href</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/^.*#/</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>));</span>
<span class='lineno'>4</span>        <span class='k'>return</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'>5</span>    <span class='p'>});</span>
<span class='lineno'>6</span> 
<span class='lineno'>7</span>    <span class='nx'>History</span><span class='p'>.</span><span class='nx'>initialize</span><span class='p'>(</span><span class='nx'>PageFlow</span><span class='p'>.</span><span class='nx'>loadPage</span><span class='p'>);</span>
<span class='lineno'>8</span> <span class='p'>});</span>
</code></pre></div>
				</div>
			</div>
		    <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'alexander-ulizko';
                // var disqus_identifier = 'unique_dynamic_id_1234';
                // var disqus_url = 'http://example.com/permalink-to-page.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- close:main-content -->
		<div id="sidebar" class="clearfix">
    <div id="sb-1">
        <a href="/about.html">About</a>
        <ul id="rss">
            <li><a href="http://feeds.feedburner.com/ulizko-com">RSS Feed of the articles</a></li>
        </ul>
    </div>
	<div id="sb-2">
		<a href="mailto:alexander@ulizko.com" class="email">alexander@ulizko.com</a>
		<br />
		<a href="http://twitter.com/aulizko" class="twitter">@aulizko</a>
		<br />
		<a href="http://http://www.facebook.com/profile.php?id=1002139259" class="facebook">Alexander Ulizko</a>
		<br />
		<a href="http://github.com/aulizko">github</a>
		<br />
		<a href="https://code.google.com/u/aulizko/">Google Code</a>
	</div><!-- close:sb-2 -->
</div><!-- close:sidebar -->
    </div><!-- close:content -->
<div id="footer">
    <p>&copy;2008&nbsp;&mdash;&nbsp;2014 <a href="http://ulizko.com">Alexander Ulizko</a></p>
	<p>Powered by <a href="https://pages.github.com/">Github Pages</a> | generated by <a href="https://github.com/mojombo/jekyll">jekyll</a> | powered by <a href="http://disqus.com">disqus</a> | themed by <a href="http://www.vostoktheme.com" hreflang="en">Vostok Theme</a></p>
</div><!-- close:footer -->
</div><!-- close:wrapper -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4326533-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>